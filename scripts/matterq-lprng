#!/bin/bash

set -e
set -o pipefail


plan()
{
    set +e
    SHIFT=`matterq-planner --verbose --svg $MQ_SPOOLDIR/images/current.svg $1`
    PLANRC=$?
    set -e

    rsvg $MQ_SPOOLDIR/images/current.svg \
         $MQ_SPOOLDIR/images/current.png
    chmod 0666 $MQ_SPOOLDIR/images/current.svg
    chmod 0666 $MQ_SPOOLDIR/images/current.png
}


#echo DFC=$datafile_count > /tmp/fs
#if [ "$datafile_count" -gt 1 ]; then
#    echo "multiple data files not supported" >&2
#    exit 2
#fi

source /etc/profile.d/matterq.sh

echo "planning print"

SHIFT=`plan $SPOOL_DIR/$DATAFILES`
RC=$?

case "$RC" in
    0)
        GCODE="$SPOOL_DIR/$DATAFILES"
        ;;
    1)
        DX=`cat $SHIFT | grep '^X' | awk '{print $2}'`
        DY=`cat $SHIFT | grep '^Y' | awk '{print $2}'`
        ZMIN=`cat $SHIFT | grep '^Z' | awk '{print $2}'`

        GCODE=`mktemp`
        cat "$SPOOL_DIR/$DATAFILES" |
            austerus-shift -x "$DX" -y "$DY" -z "$ZMIN" > "$GCODE"

        if [ "$?" -ne 0 ]
        then
            echo "shift failed"
            exit 1
        fi

        plan $SPOOL_DIR/$DATAFILES

        if [ "$?" -ne 0 ]
        then
            echo "shift replan failed"
            exit 1
        fi
        ;;
    *)
        exit 2
esac

DEPFILE=`mktemp --tmpdir="$SPOOL_DIR/matterq/depositions"`
austerus-verge -d -p "$GCODE" > "$DEPFILE"

echo "processing gcode"

austerus-send -s $GCODE
RC=$?

echo "finished"

plan

if [ "$RC" -eq 0 ]; then
    exit 0
else
    exit 2
fi

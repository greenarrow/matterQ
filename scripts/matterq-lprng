#!/bin/bash

set -e
set -o pipefail


plan()
{
    if [ "$MQ_TESTMODE" -eq 1 ]
    then
        echo matterq-planner --verbose $2 --svg $MQ_SPOOLDIR/images/current.svg $1
    fi

    set +e
    SHIFT=`matterq-planner --verbose $2 --svg $MQ_SPOOLDIR/images/current.svg $1`
    PLANRC=$?
    set -e

    rsvg $MQ_SPOOLDIR/images/current.svg \
         $MQ_SPOOLDIR/images/current.png
    chmod 0666 $MQ_SPOOLDIR/images/current.svg
    chmod 0666 $MQ_SPOOLDIR/images/current.png
}


#echo DFC=$datafile_count > /tmp/fs
#if [ "$datafile_count" -gt 1 ]; then
#    echo "multiple data files not supported" >&2
#    exit 2
#fi

if [ "$MQ_TESTMODE" -ne 1 ]
then
    source /etc/profile.d/matterq.sh
fi

GCODE=`echo "$SPOOL_DIR/$DATAFILES" | sed 's/\s*$//g'`

PARGS=""

if [ "$MQ_PLANNER_MODE" == "pack" ]
then
    PARGS="$PARGS --pack"
fi

if [ "$MQ_PLANNER_MODE" != "none" ]
then
    echo "planning print"
    plan $GCODE $PARGS
else
    PLANRC=0
fi

case "$PLANRC" in
    0)
        if [ "$MQ_PLANNER_MODE" == "pack" ]
        then
            echo "TODO shift"
        fi
        GCODE="$GCODE"
        ;;
    1)
        if [ "$MQ_PLANNER_MODE" == "abort" ]
        then
            echo "abort"
            exit 1
        fi

        echo "shift"

        DX=`echo "$SHIFT" | grep '^DX' | awk '{print $2}'`
        DY=`echo "$SHIFT" | grep '^DY' | awk '{print $2}'`

        set +e
        ZMIN=`echo "$SHIFT" | grep '^ZMIN' | awk '{print $2}'`
        set -e

        if [ -z "$ZMIN" ]
        then
            ZMIN=10
        fi

        SX=`echo "$SHIFT" | grep '^SX' | awk '{print $2}'`
        SY=`echo "$SHIFT" | grep '^SY' | awk '{print $2}'`

        OLDGCODE="$GCODE"
        GCODE=`mktemp`

        if [ "$MQ_TESTMODE" -eq 1 ]
        then
            echo austerus-shift -x "$DX" -y "$DY" -z `echo "$ZMIN + 1" | bc` -a "$SX" -b "$SY"
        fi

        cat "$OLDGCODE" |
            austerus-shift -x "$DX" -y "$DY" -z `echo "$ZMIN + 1" | bc` -a "$SX" -b "$SY" > "$GCODE"

        if [ "$?" -ne 0 ]
        then
            echo "shift failed"
            exit 1
        fi

        plan "$GCODE"

        if [ "$PLANRC" -ne 0 ]
        then
            echo "shift replan failed"
            exit 1
        fi
        ;;
    *)
        exit 2
esac

if [ "$MQ_TESTMODE" -eq 1 ]
then
    echo "gcode=$GCODE"
fi

if [ "$MQ_PLANNER_MODE" != "none" ]
then
    DEPFILE=`mktemp --tmpdir="$MQ_SPOOLDIR/depositions"`
    austerus-verge -d -p "$GCODE" > "$DEPFILE"
fi

echo "processing gcode"

if [ "$MQ_TESTMODE" -ne 1 ]
then
    austerus-send -s $GCODE
else
    echo austerus-send -s $GCODE
fi

SENDRC=$?

echo "finished"

if [ "$MQ_PLANNER_MODE" != "none" ]
then
    plan
fi

if [ "$SENDRC" -eq 0 ]; then
    exit 0
else
    exit 2
fi
